name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.deploy-worker.outputs.url }}
      pages_url: ${{ steps.deploy-pages.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install server dependencies
        run: cd server && npm ci

      - name: Setup D1 Database
        id: setup-d1
        run: |
          cd server
          DB_OUTPUT=$(npx wrangler d1 create vps-probe 2>&1) || true
          echo "$DB_OUTPUT"
          if echo "$DB_OUTPUT" | grep -q "already exists"; then
            DB_ID=$(npx wrangler d1 list --json | jq -r '.[] | select(.name=="vps-probe") | .uuid' | head -1)
          else
            # Try multiple patterns to extract ID
            DB_ID=$(echo "$DB_OUTPUT" | grep -oE '[0-9a-f-]{36}' | head -1)
            if [ -z "$DB_ID" ]; then
              DB_ID=$(echo "$DB_OUTPUT" | sed -n 's/.*database_id[" :=]*\([0-9a-f-]\{36\}\).*/\1/p' | head -1)
            fi
          fi
          if [ -z "$DB_ID" ]; then
            echo "Failed to get DB ID, listing databases..."
            DB_ID=$(npx wrangler d1 list --json | jq -r '.[] | select(.name=="vps-probe") | .uuid' | head -1)
          fi
          echo "db_id=$DB_ID" >> $GITHUB_OUTPUT
          echo "Database ID: $DB_ID"
          npx wrangler d1 execute vps-probe --remote --file=schema.sql --yes || true

      - name: Setup KV Namespace
        id: setup-kv
        run: |
          cd server
          KV_OUTPUT=$(npx wrangler kv:namespace create STATUS_KV 2>&1) || true
          echo "$KV_OUTPUT"
          if echo "$KV_OUTPUT" | grep -q "already exists"; then
            KV_ID=$(npx wrangler kv:namespace list --json | jq -r '.[] | select(.title | contains("STATUS_KV")) | .id' | head -1)
          else
            # Try multiple patterns to extract ID
            KV_ID=$(echo "$KV_OUTPUT" | grep -oE '[0-9a-f]{32}' | head -1)
            if [ -z "$KV_ID" ]; then
              KV_ID=$(echo "$KV_OUTPUT" | sed -n 's/.*id[" :=]*\([0-9a-f]\{32\}\).*/\1/p' | head -1)
            fi
          fi
          if [ -z "$KV_ID" ]; then
            echo "Failed to get KV ID, listing namespaces..."
            KV_ID=$(npx wrangler kv:namespace list --json | jq -r '.[] | select(.title | contains("STATUS_KV")) | .id' | head -1)
          fi
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
          echo "KV ID: $KV_ID"

      - name: Generate wrangler.toml
        env:
          DB_ID: ${{ steps.setup-d1.outputs.db_id }}
          KV_ID: ${{ steps.setup-kv.outputs.kv_id }}
        run: |
          cat > server/wrangler.toml << EOF
          name = "vps-probe"
          main = "src/index.ts"
          compatibility_date = "2024-01-01"

          [vars]
          PROBE_STATUS_TTL_SECONDS = "120"

          [[d1_databases]]
          binding = "DB"
          database_name = "vps-probe"
          database_id = "${DB_ID}"

          [[kv_namespaces]]
          binding = "STATUS_KV"
          id = "${KV_ID}"
          EOF
          sed -i 's/^          //' server/wrangler.toml
          cat server/wrangler.toml

      - name: Setup HMAC Secret
        id: setup-secret
        run: |
          cd server
          SECRET=$(openssl rand -hex 32)
          echo "$SECRET" | npx wrangler secret put PROBE_HMAC_SECRET
          echo "secret=$SECRET" >> $GITHUB_OUTPUT

      - name: Deploy Worker
        id: deploy-worker
        run: |
          cd server
          DEPLOY_OUTPUT=$(npx wrangler deploy 2>&1)
          echo "$DEPLOY_OUTPUT"
          URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^[:space:]]*workers\.dev' | head -1)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Worker deployed to: $URL"

      - name: Build Dashboard
        run: |
          cd dashboard
          npm ci
          VITE_API_URL="${{ steps.deploy-worker.outputs.url }}/v1" npm run build

      - name: Deploy Dashboard
        id: deploy-pages
        run: |
          cd dashboard
          npx wrangler pages project create vps-probe-dashboard --production-branch main 2>/dev/null || true
          PAGES_OUTPUT=$(npx wrangler pages deploy dist --project-name vps-probe-dashboard --commit-dirty=true 2>&1)
          echo "$PAGES_OUTPUT"
          URL=$(echo "$PAGES_OUTPUT" | grep -o 'https://[^[:space:]]*pages\.dev' | tail -1)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Dashboard deployed to: $URL"

      - name: Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.deploy-worker.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ steps.deploy-pages.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### HMAC Secret (Save this!)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.setup-secret.outputs.secret }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install Agent on VPS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sudo bash -s -- \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --url ${{ steps.deploy-worker.outputs.url }}/v1/ingest \\\\" >> $GITHUB_STEP_SUMMARY
          echo "  --secret ${{ steps.setup-secret.outputs.secret }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
